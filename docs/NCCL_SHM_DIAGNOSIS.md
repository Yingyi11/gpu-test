# NCCL å…±äº«å†…å­˜è¯Šæ–­æŠ¥å‘Š

## ğŸ” é—®é¢˜æº¯æº

### åŸå§‹é”™è¯¯ä¿¡æ¯
```
[2025-11-11 16:54:54] ubuntu:87133:87286 [1] misc/shmutils.cc:93 
NCCL WARN Call to open failed: No such file or directory         

[2025-11-11 16:54:54] ubuntu:87133:87286 [1] misc/shmutils.cc:129
NCCL WARN Error while attaching to shared memory segment /dev/shm/nccl-ï¿½ (size 0), 
error: No such file or directory (2)
```

### âŒ æœ€åˆçš„å‡è®¾ï¼ˆé”™è¯¯ï¼ï¼‰
è®¤ä¸ºç³»ç»Ÿæ— æ³•ä½¿ç”¨å…±äº«å†…å­˜ï¼Œå› æ­¤è®¾ç½®äº† `NCCL_SHM_DISABLE=1`

---

## âœ… çœŸå®æƒ…å†µ

### ç³»ç»Ÿå…±äº«å†…å­˜çŠ¶æ€æ£€æŸ¥

#### 1. /dev/shm ç›®å½•çŠ¶æ€
```bash
$ df -h /dev/shm
Filesystem      Size  Used  Avail Use% Mounted on
tmpfs           126G   37M   126G   1% /dev/shm
```
âœ… **æ­£å¸¸**: 126GB å…±äº«å†…å­˜ï¼Œä»…ä½¿ç”¨ 1%

#### 2. å…±äº«å†…å­˜æ®µæ£€æŸ¥
```bash
$ ipcs -m
# æ˜¾ç¤ºå¤šä¸ªæ­£åœ¨ä½¿ç”¨çš„å…±äº«å†…å­˜æ®µ
# åŒ…æ‹¬å¤šä¸ª NCCL å…±äº«å†…å­˜æ–‡ä»¶ (nccl-*)
```
âœ… **æ­£å¸¸**: ç³»ç»Ÿæ”¯æŒå…±äº«å†…å­˜ï¼ŒNCCL æ–‡ä»¶å·²å­˜åœ¨

#### 3. ç³»ç»Ÿé™åˆ¶
```bash
$ cat /proc/sys/kernel/shmmni
4096  # æœ€å¤§å…±äº«å†…å­˜æ®µæ•°é‡

$ cat /proc/sys/kernel/shmmax
18446744073692774399  # å•ä¸ªæ®µæœ€å¤§å¤§å° (~16 EB)
```
âœ… **æ­£å¸¸**: ç³»ç»Ÿé™åˆ¶éå¸¸å®½æ¾

---

## ğŸ§ª æ€§èƒ½å¯¹æ¯”æµ‹è¯•

### æµ‹è¯•é…ç½®
- GPU: 8 å¡
- Batch Size: 128/GPU
- è¿­ä»£æ¬¡æ•°: 50
- é¢„çƒ­: 5 æ¬¡

### ç»“æœå¯¹æ¯”

| é…ç½® | å¹³å‡ååé‡ | æ¯ GPU ååé‡ | å¹³å‡è¿­ä»£æ—¶é—´ | ä¸­ä½æ•°æ—¶é—´ |
|------|-----------|--------------|-------------|----------|
| **å¯ç”¨å…±äº«å†…å­˜** (SHM_DISABLE=0) | 4605.7 img/s | 575.7 img/s | 225.65 ms | 213.19 ms |
| **ç¦ç”¨å…±äº«å†…å­˜** (SHM_DISABLE=1) | 4607.6 img/s | 576.0 img/s | 228.60 ms | 213.63 ms |
| **æ€§èƒ½å·®å¼‚** | +0.04% | +0.05% | -1.3% | -0.2% |

### ğŸ“Š ç»“è®º
**å¯ç”¨/ç¦ç”¨å…±äº«å†…å­˜æ€§èƒ½å‡ ä¹ç›¸åŒï¼** (å·®å¼‚ < 1%)

---

## ğŸ¤” ä¸ºä»€ä¹ˆæ€§èƒ½å·®å¼‚è¿™ä¹ˆå°ï¼Ÿ

### å¯èƒ½çš„åŸå› 

#### 1. **GPU æ‹“æ‰‘ç»“æ„** â­ æœ€å¯èƒ½
```bash
# æ£€æŸ¥ GPU æ‹“æ‰‘
nvidia-smi topo -m
```
å¦‚æœ GPU ä¹‹é—´æœ‰ **NVLink** æˆ– **PCIe ç›´è¿**ï¼ŒNCCL ä¼šä¼˜å…ˆä½¿ç”¨è¿™äº›æ›´å¿«çš„é€šé“ï¼š
- **NVLink**: 600 GB/s (V100) æˆ– 900 GB/s (A100)
- **PCIe 4.0 x16**: ~32 GB/s
- **å…±äº«å†…å­˜**: ~100 GB/s (ä½†ä»…é™å•æœº)

å½“æœ‰æ›´å¿«çš„ç¡¬ä»¶äº’è”æ—¶ï¼Œå…±äº«å†…å­˜å¹¶éæ€§èƒ½ç“¶é¢ˆã€‚

#### 2. **NCCL æ™ºèƒ½è·¯ç”±**
NCCL 2.x ä¼šè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜é€šä¿¡è·¯å¾„ï¼š
```
ä¼˜å…ˆçº§: NVLink > PCIe P2P > å…±äº«å†…å­˜ > Socket
```

#### 3. **è®¡ç®—å¯†é›†å‹å·¥ä½œè´Ÿè½½**
ResNet50 çš„è®¡ç®—é‡è¿œå¤§äºé€šä¿¡é‡ï¼š
- å‰å‘+åå‘ä¼ æ’­: ~150-200 ms
- æ¢¯åº¦åŒæ­¥: ~10-30 ms (ä»…å  10-15%)

é€šä¿¡ä¼˜åŒ–å¸¦æ¥çš„æå‡æœ‰é™ã€‚

#### 4. **Batch Size è¶³å¤Ÿå¤§**
```
Batch Size 128 Ã— 8 GPU = 1024 images/batch
```
å¤§ batch size æ‘Šè–„äº†é€šä¿¡å¼€é”€çš„å½±å“ã€‚

---

## ğŸ”§ åŸå§‹é”™è¯¯çš„çœŸæ­£åŸå› 

### åˆ†æé”™è¯¯æ¶ˆæ¯
```
Error while attaching to shared memory segment /dev/shm/nccl-ï¿½ (size 0)
```

å…³é”®ä¿¡æ¯:
1. **æ–‡ä»¶åä¹±ç ** (`nccl-ï¿½`): å­—ç¬¦ç¼–ç é—®é¢˜
2. **size 0**: NCCL å°è¯•æ‰“å¼€ä¸€ä¸ª**ä¸å­˜åœ¨æˆ–å·²åˆ é™¤**çš„å…±äº«å†…å­˜æ–‡ä»¶
3. **No such file or directory**: æ–‡ä»¶ç¡®å®ä¸å­˜åœ¨

### ğŸ¯ æ ¹æœ¬åŸå› 

#### æƒ…å†µ 1: **æ®‹ç•™çš„å…±äº«å†…å­˜æ–‡ä»¶** (æœ€å¯èƒ½)
```bash
# ä¹‹å‰çš„ NCCL è¿›ç¨‹å¼‚å¸¸é€€å‡ºï¼Œç•™ä¸‹äº†æŸåçš„å…±äº«å†…å­˜æ–‡ä»¶å¼•ç”¨
# ä½†æ–‡ä»¶å·²è¢«æ¸…ç†ï¼Œæ–°è¿›ç¨‹å°è¯•è¿æ¥æ—¶å¤±è´¥
```

**è§£å†³æ–¹æ³•**:
```bash
# æ¸…ç†æ‰€æœ‰ NCCL å…±äº«å†…å­˜æ–‡ä»¶
rm -f /dev/shm/nccl-*
```

#### æƒ…å†µ 2: **å¹¶å‘è®¿é—®å†²çª**
å¤šä¸ª NCCL è¿›ç¨‹åŒæ—¶å¯åŠ¨æ—¶ï¼Œå¯èƒ½å‡ºç°ç«æ€æ¡ä»¶ï¼š
- è¿›ç¨‹ A åˆ›å»ºæ–‡ä»¶
- è¿›ç¨‹ B æ£€æµ‹åˆ°æ–‡ä»¶å­˜åœ¨
- è¿›ç¨‹ A è¿˜æœªå®Œæˆåˆå§‹åŒ–
- è¿›ç¨‹ B å°è¯•æ‰“å¼€ â†’ å¤±è´¥

**è§£å†³æ–¹æ³•**: NCCL ä¼šè‡ªåŠ¨é‡è¯•ï¼Œé€šå¸¸ä¸éœ€è¦æ‰‹åŠ¨å¹²é¢„

#### æƒ…å†µ 3: **æƒé™é—®é¢˜** (ä¸å¤ªå¯èƒ½)
å…±äº«å†…å­˜æ–‡ä»¶æƒé™ä¸åŒ¹é…ã€‚

æ£€æŸ¥æ–¹æ³•:
```bash
ls -la /dev/shm/nccl-*
# åº”è¯¥æ˜¾ç¤º: -rw------- m m
```

---

## âœ… æœ€ä½³å®è·µå»ºè®®

### 1. **æ¨èé…ç½®** (ä¿æŒé»˜è®¤)
```python
# ä¸è®¾ç½® NCCL_SHM_DISABLEï¼Œè®© NCCL è‡ªåŠ¨é€‰æ‹©
# os.environ['NCCL_SHM_DISABLE'] = '1'  # âŒ åˆ é™¤è¿™è¡Œ

# ä»…ä¿ç•™å¿…è¦çš„ä¼˜åŒ–
os.environ['NCCL_DEBUG'] = 'WARN'
os.environ['NCCL_IB_DISABLE'] = '1'  # æœ¬åœ°è®­ç»ƒä¸éœ€è¦ IB
os.environ['NCCL_P2P_DISABLE'] = '0'  # å¯ç”¨ GPU P2P
```

### 2. **é‡åˆ°å…±äº«å†…å­˜é”™è¯¯æ—¶**
```bash
# æ­¥éª¤ 1: æ¸…ç†æ®‹ç•™æ–‡ä»¶
rm -f /dev/shm/nccl-*

# æ­¥éª¤ 2: é‡æ–°è¿è¡Œ
uv run torchrun ...

# å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œæ‰è€ƒè™‘ç¦ç”¨å…±äº«å†…å­˜
NCCL_SHM_DISABLE=1 uv run torchrun ...
```

### 3. **æ€§èƒ½è°ƒè¯•**
```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
NCCL_DEBUG=INFO uv run torchrun ... 2>&1 | grep "Using"

# ä¼šæ˜¾ç¤ºç±»ä¼¼:
# NCCL INFO Using network Socket
# NCCL INFO Channel 00/02 : 0 -> 1 via P2P/IPC/SHM
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ä¼˜å…ˆçº§

æ ¹æ®æµ‹è¯•ç»“æœï¼Œä¼˜åŒ–æªæ–½çš„é‡è¦æ€§æ’åºï¼š

1. â­â­â­ **å¢å¤§ Batch Size** (+74% ååé‡)
2. â­â­â­ **æ··åˆç²¾åº¦è®­ç»ƒ** (é¢„æœŸ +50-100%)
3. â­â­ **DataLoader ä¼˜åŒ–** (+5-10%)
4. â­â­ **cuDNN benchmark** (+5-10%)
5. â­ **DDP å‚æ•°ä¼˜åŒ–** (+3-5%)
6. âšª **å…±äº«å†…å­˜ vs Socket** (~0%, å¯å¿½ç•¥)

---

## ğŸ“ ç»“è®º

### ä¸»è¦å‘ç°

1. âœ… **ç³»ç»Ÿå®Œå…¨æ”¯æŒå…±äº«å†…å­˜** - åˆå§‹é”™è¯¯æ˜¯è¯¯åˆ¤
2. âœ… **å¯ç”¨/ç¦ç”¨å…±äº«å†…å­˜æ€§èƒ½å‡ ä¹ç›¸åŒ** - ç¡¬ä»¶äº’è”æ›´å…³é”®
3. âœ… **åŸå§‹é”™è¯¯å¯èƒ½æ˜¯ä¸´æ—¶é—®é¢˜** - æ®‹ç•™æ–‡ä»¶æˆ–ç«æ€æ¡ä»¶
4. âœ… **`NCCL_SHM_DISABLE=1` ä¸æ˜¯å¿…éœ€çš„** - å¯ä»¥å®‰å…¨ç§»é™¤

### å»ºè®®è¡ŒåŠ¨

#### ç«‹å³æ‰§è¡Œ
```bash
# 1. æ¸…ç†æ®‹ç•™æ–‡ä»¶
rm -f /dev/shm/nccl-*

# 2. ä¿®æ”¹è„šæœ¬ï¼Œç§»é™¤ NCCL_SHM_DISABLE
# ç¼–è¾‘ benchmark_resnet50.pyï¼Œåˆ é™¤æˆ–æ³¨é‡Šæ‰:
# os.environ['NCCL_SHM_DISABLE'] = '1'

# 3. é‡æ–°æµ‹è¯•
uv run torchrun --nproc_per_node=8 benchmark_resnet50.py --batch-size 128
```

#### å¦‚æœé‡åˆ°é—®é¢˜
```bash
# æ–¹æ¡ˆ A: ä¸´æ—¶ç¦ç”¨ï¼ˆæ€§èƒ½æŸå¤±å¯å¿½ç•¥ï¼‰
NCCL_SHM_DISABLE=1 uv run torchrun ...

# æ–¹æ¡ˆ B: æ£€æŸ¥ GPU æ‹“æ‰‘
nvidia-smi topo -m

# æ–¹æ¡ˆ C: å¯ç”¨ NCCL è°ƒè¯•
NCCL_DEBUG=INFO uv run torchrun ... 2>&1 | tee nccl.log
```

---

## ğŸ“ ç›¸å…³èµ„æº

- [NCCL å®˜æ–¹æ–‡æ¡£](https://docs.nvidia.com/deeplearning/nccl/)
- [NCCL ç¯å¢ƒå˜é‡å‚è€ƒ](https://docs.nvidia.com/deeplearning/nccl/user-guide/docs/env.html)
- [PyTorch DDP æœ€ä½³å®è·µ](https://pytorch.org/tutorials/intermediate/ddp_tutorial.html)

---

ç”Ÿæˆæ—¶é—´: 2025-11-11 17:17  
æµ‹è¯•ç¯å¢ƒ: PyTorch 2.9.0, CUDA 12.8, 8x GPU  
NCCL ç‰ˆæœ¬: 2.27.5
